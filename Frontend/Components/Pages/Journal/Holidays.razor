@page "/journal/{journalId:int}/Holidays/{pageId:int}"

@inherits TablePageBase

@attribute [Authorize]

@using Contracts.Journal
@using Contracts.Journal.Holidays
@using Frontend.Components.Buttons
@using Frontend.Components.Pages.ReferencePages.HolidayType
@using Frontend.Components.Utils
@using Frontend.Services
@using Frontend.Utils

@inject HttpClient HttpClient
@inject JournalState JournalState
@inject IJSRuntime JSRuntime

<PageTitle>Праздники</PageTitle>

@if (_pageData == null)
{
    <p><em>Загрузка...</em></p>
}
else
{
    <AddButton @onclick="OpenAddTypeModal" IsDisabled="_pageData.HolidayTypes.Where(ht => ht.Holidays.Count == 0).Count() == 0">Добавить категорию</AddButton>
    <Modal IsVisible="_isAddTypeModalVisible" OnClose="CloseAddTypeModal">
        <div class="container">
            <div class="row">
                <div class="col d-flex align-items-center justify-content-center">
                    <h3>Добавить категорию</h3>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex align-items-center justify-content-center">
                    <select @bind="_typeToAddId" class="input underline mb-3 fullwidth">
                        @foreach (var ht in _pageData.HolidayTypes.Where(ht => ht.Holidays.Count == 0))
                        {
                            <option @key="ht.Id" value="@ht.Id">@ht.Name</option>
                        }
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col d-flex align-items-start justify-content-start">
                    <ReferenceButton Uri="/HolidayTypes">Категории праздников</ReferenceButton>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex align-items-center justify-content-center">
                    <AddButton IsDisabled="@(_typeToAddId == -1)" @onclick="async () => { await Add(_typeToAddId); CloseAddTypeModal(); }" style="width:100%">Добавить</AddButton>
                </div>
            </div>
        </div>
    </Modal>

    @foreach (var ht in _pageData.HolidayTypes.Where(ht => ht.Holidays.Count > 0))
    {
        <h3 class="d-flex justify-content-center">
            @ht.Name
        </h3>
        <table class="table table-bordered">
            <tbody>
                @foreach (var h in ht.Holidays)
                {
                    <tr class="@GetRowClass(h.Id)">
                        <td class="align-middle col-sm-1">
                            <input id="isRelativeDate" type="checkbox" @bind="h.IsRelativeDate" @bind:after="async () => await Update(h)" class="input" />
                            <label for="isRelativeDate">Относ. дата</label>
                        </td>
                        <td class="align-middle col-5">
                            @if (!h.IsRelativeDate)
                            {
                                <input type="number" min="1" max="31" step="1" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                                @bind="h.Day" @bind:after="async () => await Update(h)" class="input" />
                            }
                            else
                            {
                                <input @bind="h.RelativeDate" @bind:after="async () => await Update(h)" class="input" />
                            }
                            <select @bind="h.Month" @bind:after="async () => await Update(h)" class="input">
                                <option value="">(нет)</option>
                                @foreach (var m in MonthsUtils.MonthsDateNames)
                                {
                                    <option @key="m.Key" value="@m.Key">@m.Value</option>
                                }
                            </select>
                        </td>
                        <td class="align-middle col-6">
                            <textarea rows="1" style="overflow:hidden; resize:none;" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
                                @bind="h.Name" @bind:after="async () => await Update(h)" class="input fullwidth" />
                        </td>
                        <td class="align-middle">
                            <DeleteButton @onclick="() => OpenDeleteModal(h.Id)" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <AddButton @onclick="async () => await Add(ht.Id)">Добавить</AddButton>
    }

    <ConfirmDeleteModal IsVisible="_isDeleteModalVisible" OnClose="CloseDeleteModal" IdToDelete="_idToDelete" OnDeleteById="Delete" />

    <AlertBottom IsVisible="_isServerErrorAlertVisible" OnClose="CloseServerErrorAlert">@_errorMessage</AlertBottom>
}

@code {
    [Parameter]
    public int PageId { get; set; }

    [Parameter]
    public int JournalId { get; set; }

    private HolidaysPageResponse? _pageData;

    private int _typeToAddId = -1;

    private bool _isAddTypeModalVisible = false;

    protected override async Task OnInitializedAsync()
    {
        await JournalState.Initialize(JournalId, PageId);

        _pageData = await HttpClient.GetFromJsonAsync<HolidaysPageResponse>("api/journal/holiday/" + PageId);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await Task.Delay(10);
        await JSRuntime.InvokeVoidAsync("resizeTextAreas");
    }

    private async Task Add(int typeId)
    {
        var request = new CreateHolidayRequest(null, null, null, null, false, typeId, PageId);
        var response = await HttpClient.PostAsJsonAsync<CreateHolidayRequest>("api/journal/holiday", request);

        if (response.IsSuccessStatusCode)
        {
            var addedRecord = await response.Content.ReadFromJsonAsync<HolidayResponse>();
            _pageData!.HolidayTypes.FirstOrDefault(ht => ht.Id == typeId)!.Holidays.Add(addedRecord!);
        }
        else
        {
            var errorMessage = (await response.Content.ReadAsStringAsync()).Split('\n').FirstOrDefault();
            ShowServerErrorAlert(errorMessage);
        }
    }

    private async Task Update(HolidayResponse holiday)
    {
        _rowsWithErrors.Remove(holiday.Id);
        CloseServerErrorAlert();

        var request = new UpdateHolidayRequest(holiday.Day, holiday.Month, holiday.RelativeDate, holiday.Name, holiday.IsRelativeDate);
        var response = await HttpClient.PutAsJsonAsync<UpdateHolidayRequest>("api/journal/holiday/" + holiday.Id, request);

        if (!response.IsSuccessStatusCode)
        {
            _rowsWithErrors.Add(holiday.Id);
            var errorMessage = (await response.Content.ReadAsStringAsync()).Split('\n').FirstOrDefault();
            ShowServerErrorAlert(errorMessage);
        }
    }

    private async Task Delete(int holidayId)
    {
        var response = await HttpClient.DeleteAsync("api/journal/holiday/" + holidayId);
        if (response.IsSuccessStatusCode) _pageData!.HolidayTypes.ForEach(ht => ht.Holidays.RemoveAll(h => h.Id == holidayId));
        else
        {
            var errorMessage = (await response.Content.ReadAsStringAsync()).Split('\n').FirstOrDefault();
            ShowServerErrorAlert(errorMessage);
        }
    }

    private void OpenAddTypeModal()
    {
        _isAddTypeModalVisible = true;
    }

    private void CloseAddTypeModal()
    {
        _isAddTypeModalVisible = false;
        _typeToAddId = -1;
    }
}
