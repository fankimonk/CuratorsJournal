@page "/journal/{journalId:int}/SocioPedagogicalCharacteristics/{pageId:int}"

@inherits CRUDPageBase

@attribute [Authorize]

@using Contracts.AcademicYears
@using Contracts.Groups
@using Contracts.Journal.SocioPedagogicalCharacteristics
@using Contracts.Mappers
@using Contracts.Mappers.Journal
@using Frontend.Components.Buttons
@using Frontend.Components.Utils
@using Frontend.Services

@inject HttpClient HttpClient
@inject JournalState JournalState
@inject IJSRuntime JSRuntime

<PageTitle>Социально-педагогическая характеристика</PageTitle>

<h3 class="d-flex justify-content-center">СОЦИАЛЬНО-ПЕДАГОГИЧЕСКАЯ ХАРАКТЕРИСТИКА</h3>

@if (_pageData == null)
{
    <p><em>Загрузка...</em></p>
}
else
{
    @if (_group == null)
    {
        <p><em>Загрузка...</em></p>
    }
    else
    {
        <h3 class="d-flex justify-content-center">
            учебной группы @_group.Number.ToString()
            @if (_academicYears != null)
            {
                @if (JournalState.IsCurrentPageApproved)
                {
                    var academicYear = _academicYears.FirstOrDefault(a => a.Id == _pageData.Attributes.AcademicYearId);
                    var academicYearStr = academicYear == null ? "(нет)" : academicYear.StartYear + " / " + academicYear.EndYear; 
                    <span> в @academicYearStr уч. году</span>
                }
                else
                {
                    @(" в ")
                    <select @bind="_pageData.Attributes.AcademicYearId" @bind:after="UpdateAttributes" class="input underline text-center ms-2">
                        <option value="">(нет)</option>
                        @foreach (var academicYear in _academicYears)
                        {
                            <option @key="academicYear.Id" value="@academicYear.Id">
                                @academicYear.StartYear / @academicYear.EndYear
                            </option>
                        }
                    </select>
                    <ReferenceButton ButtonSize="ButtonSizes.Small" Uri="/AcademicYears" AdditionalClasses="me-2" />
                    @(" уч. году ")
                }
            }
        </h3>
    }

    <p>
        1. Всего студентов
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.TotalStudents</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
            @bind="_pageData.TotalStudents" @bind:after="Update" class="input underline" />
        }
    </p>
    <p>Из них</p>
    <p>
        2. Девушки
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.FemalesCount</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.FemalesCount" @bind:after="Update" class="input underline" />
        }
    </p>
    <p>
        3. Юноши
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.MalesCount</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.MalesCount" @bind:after="Update" class="input underline" />
        }
    </p>
    <p>
        4. Члены ОО "БРСМ"
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.BRSMMembersCount</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.BRSMMembersCount" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        5. Дети-сироты, (до 18 лет)
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.OrphansUnderagesCount</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.OrphansUnderagesCount" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        6. Дети, оставшиеся без попечения родителей (до 18 лет)
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsWithoutParentalCareUnderagesCount</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsWithoutParentalCareUnderagesCount" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        7. Лица из числа детей-сирот <br />
        и детей, оставшихся без попечения родителей (18-23 года)
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.OrphansOrStudentsWithoutParentalCareAdults</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.OrphansOrStudentsWithoutParentalCareAdults" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        8. Студенты с особенностями психофизического развития
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsWithSpecialPsychophysicalDevelopmentNeeds</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsWithSpecialPsychophysicalDevelopmentNeeds" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        9. Имеющие родителей-инвалидов 1, 2 группы
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsWithDisabledParentsOfGroups1and2</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsWithDisabledParentsOfGroups1and2" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        10. Из многодетных семей
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsFromLargeFamilies</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsFromLargeFamilies" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        11. Из неполных семей
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsFromSingleParentFamilies</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsFromSingleParentFamilies" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        12. Из регионов, пострадавших от катастрофы на Чернобыльской АЭС
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsFromRegionsAffectedByChernobylDisaster</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsFromRegionsAffectedByChernobylDisaster" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        13. Из семей, отселенных из зон радиоактивного загрязнения
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsFromFamiliesRelocatedFromAreasOfRadioactivePollution</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsFromFamiliesRelocatedFromAreasOfRadioactivePollution" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        14. Иногородних
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.NonResidentStudents</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.NonResidentStudents" @bind:after="Update" class="input underline" />
        }
    </p>
    <p>
        15. Проживают с родителями
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsLivingWithParents</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsLivingWithParents" @bind:after="Update" class="input underline" />
        }
        , в общежитии
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsLivingInADormitory</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsLivingInADormitory" @bind:after="Update" class="input underline" />
        }
        , <br />у родственников
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsLivingWithRelatives</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsLivingWithRelatives" @bind:after="Update" class="input underline" />
        }
        , на частных квартирах
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.StudentsLivingInPrivateApartments</span>
        }
        else
        {
            <input type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                   @bind="_pageData.StudentsLivingInPrivateApartments" @bind:after="Update" class="input underline" />
        }
        
    </p>
    <p>
        16. Другие сведения <br />
        @if (JournalState.IsCurrentPageApproved)
        {
            <span style="text-decoration: underline;">@_pageData.OtherInformation</span>
        }
        else
        {
            <textarea rows="1" style="overflow:hidden; resize:none;" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
                      @bind="_pageData.OtherInformation" @bind:after="Update" class="input underline fullwidth" />
        }
    </p>

    <AlertBottom IsVisible="_isServerErrorAlertVisible" OnClose="CloseServerErrorAlert">@_errorMessage</AlertBottom>
}

@code {
    [Parameter]
    public int PageId { get; set; }

    [Parameter]
    public int JournalId { get; set; }

    private SocioPedagogicalCharacteristicsResponse? _pageData;

    private GroupResponse? _group;

    private List<AcademicYearResponse>? _academicYears;

    protected override async Task OnInitializedAsync()
    {
        JournalState.OnToggleIsApproved += StateHasChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await JournalState.Initialize(JournalId, PageId);

        _pageData = await HttpClient.GetFromJsonAsync<SocioPedagogicalCharacteristicsResponse>("api/journal/sociopedagogicalcharacteristics/" + PageId.ToString());
        _group = await HttpClient.GetFromJsonAsync<GroupResponse>("api/group/getbyjournal/" + JournalId.ToString());
     
        var getAcademicYearsUri = "api/academicyear/getsinceyear/";
        if (_group != null)
            _academicYears = await HttpClient.GetFromJsonAsync<List<AcademicYearResponse>>(getAcademicYearsUri + _group.AdmissionYear.ToString());
        else
            _academicYears = await HttpClient.GetFromJsonAsync<List<AcademicYearResponse>>(getAcademicYearsUri);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await Task.Delay(10);
        await JSRuntime.InvokeVoidAsync("resizeTextAreas");
    }

    private async Task Update()
    {
        var request = _pageData!.ToRequest();
        var response = await HttpClient.PutAsJsonAsync<UpdateSocioPedagogicalCharacteristicsRequest>
            ("api/journal/sociopedagogicalcharacteristics/" + _pageData!.Id, request);

        if (!response.IsSuccessStatusCode)
        {
            var errorMessage = (await response.Content.ReadAsStringAsync()).Split('\n').FirstOrDefault();
            ShowServerErrorAlert(errorMessage);
        }
    }

    private async Task UpdateAttributes()
    {
        var request = new UpdateSocioPedagogicalCharacteristicsPageAttributesRequest(_pageData!.Attributes.AcademicYearId);
        var response = await HttpClient.PutAsJsonAsync<UpdateSocioPedagogicalCharacteristicsPageAttributesRequest>
            ("api/journal/sociopedagogicalcharacteristics/updateattributes/" + _pageData!.Attributes.Id, request);

        if (!response.IsSuccessStatusCode)
        {
            var errorMessage = (await response.Content.ReadAsStringAsync()).Split('\n').FirstOrDefault();
            ShowServerErrorAlert(errorMessage);
        }
    }
}